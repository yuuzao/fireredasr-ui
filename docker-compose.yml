version: '3.8'

services:
  fireredasr-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fireredasr-ui
    ports:
      - "35078:5078"
    volumes:
      # ============================================
      # 模型目录映射（只读，防止容器意外修改模型文件）
      # ============================================
      # AED 模型目录映射
      # 包含: model.pth.tar, config.yaml, cmvn.ark, dict.txt, train_bpe1000.model 等
      - ./pretrained_models/FireRedASR-AED-L:/app/pretrained_models/FireRedASR-AED-L:ro
      # LLM 模型目录映射（包含主模型和 Qwen2-7B-Instruct 子模型）
      # 包含: model.pth.tar, config.yaml, cmvn.ark 等
      - ./pretrained_models/FireRedASR-LLM-L:/app/pretrained_models/FireRedASR-LLM-L:ro
      # Qwen2-7B-Instruct 模型目录（LLM 模型的依赖）
      # 包含: model-00001-of-00004.safetensors 等 4 个分片文件
      - ./pretrained_models/FireRedASR-LLM-L/Qwen2-7B-Instruct:/app/pretrained_models/FireRedASR-LLM-L/Qwen2-7B-Instruct:ro
      # 或者使用整个 pretrained_models 目录映射（如果上述分别映射有问题，可以使用这个）
      # - ./pretrained_models:/app/pretrained_models:ro

      # ============================================
      # 数据目录映射（读写，用于持久化数据）
      # ============================================
      # 日志目录映射（持久化日志文件，按日期分割）
      - ./logs:/app/logs
      # 临时文件目录映射（用于存储上传的音频文件和转换后的 WAV 文件）
      # 注意：此目录会存储大量临时文件，建议定期清理或使用 tmpfs 挂载
      - ./static/tmp:/app/static/tmp
    environment:
      - HOST=0.0.0.0
      - PORT=5078
      - BATCH=1
    # GPU 支持（如果系统有 NVIDIA GPU，取消下面的注释）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5078/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

