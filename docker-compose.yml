version: '3.8'

services:
  fireredasr-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fireredasr-ui
    ports:
      - "35078:5078"
    volumes:
      # ============================================
      # 数据目录映射（读写，用于持久化数据）
      - ./pretrained_models:/app/pretrained_models:ro
      # ============================================
      # 日志目录映射（持久化日志文件，按日期分割）
      - ./logs:/app/logs
      # 临时文件目录映射（用于存储上传的音频文件和转换后的 WAV 文件）
      # 注意：此目录会存储大量临时文件，建议定期清理或使用 tmpfs 挂载
      - ./static/tmp:/app/static/tmp
    environment:
      - HOST=0.0.0.0
      - PORT=5078
      - BATCH=3
    # GPU 支持（如果系统有 NVIDIA GPU，取消下面的注释）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5078/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

